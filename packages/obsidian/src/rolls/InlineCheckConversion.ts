// Table: https://docs.google.com/spreadsheets/d/17lA-ymHQKg38AHzyQQT8X7BoOoYlfc5FKucpwGUh0N8/edit?gid=0#gid=0
// 1		2		3		4		5		6		7		8		9		10		11		12		13		14		15		16		17		18		19		20
// -2	5	-1	6	0	8	1	9	2	10	3	12	4	13	5	14	6	16	7	17	8	18	9	20	10	21	11	22	12	24	13	25	14	26	15	28	16	29	17	30
// -1	6	0	7	1	9	2	10	3	11	4	13	5	14	6	15	7	17	8	18	9	19	10	21	11	22	12	23	13	25	14	26	15	27	16	29	17	30	18	31
// 0	7	1	8	2	10	3	11	4	12	5	14	6	15	7	16	8	18	9	19	10	20	11	22	12	23	13	24	14	26	15	27	16	28	17	30	18	31	19	32
// 1	8	2	9	3	11	4	12	5	13	6	15	7	16	8	17	9	19	10	20	11	21	12	23	13	24	14	25	15	27	16	28	17	29	18	31	19	32	20	33
// 2	9	3	10	4	12	5	13	6	14	7	16	8	17	9	18	10	20	11	21	12	22	13	24	14	25	15	26	16	28	17	29	18	30	19	32	20	33	21	34
// 3	10	4	11	5	13	6	14	7	15	8	17	9	18	10	19	11	21	12	22	13	23	14	25	15	26	16	27	17	29	18	30	19	31	20	33	21	34	22	35
// 4	11	5	12	6	14	7	15	8	16	9	18	10	19	11	20	12	22	13	23	14	24	15	26	16	27	17	28	18	30	19	31	20	32	21	34	22	35	23	36
// 5	11	6	12	7	14	8	15	9	16	10	18	11	19	12	20	13	22	14	23	15	24	16	26	17	27	18	28	19	30	20	31	21	32	22	34	23	35	24	36
// 6	12	7	13	8	15	9	16	10	17	11	19	12	20	13	21	14	23	15	24	16	25	17	27	18	28	19	29	20	31	21	32	22	33	23	35	24	36	25	37
// 7	12	8	13	9	15	10	16	11	17	12	19	13	20	14	21	15	23	16	24	17	25	18	27	19	28	20	29	21	31	22	32	23	33	24	35	25	36	26	37
// 8	13	9	14	10	16	11	17	12	18	13	20	14	21	15	22	16	24	17	25	18	26	19	28	20	29	21	30	22	32	23	33	24	34	25	36	26	37	27	38
// 9	13	10	14	11	16	12	17	13	18	14	20	15	21	16	22	17	24	18	25	19	26	20	28	21	29	22	30	23	32	24	33	25	34	26	36	27	37	28	38
// 10	14	11	15	12	17	13	18	14	19	15	21	16	22	17	23	18	25	19	26	20	27	21	29	22	30	23	31	24	33	25	34	26	35	27	37	28	38	29	39
// 11	14	12	15	13	17	14	18	15	19	16	21	17	22	18	23	19	25	20	26	21	27	22	29	23	30	24	31	25	33	26	34	27	35	28	37	29	38	30	39
// 12	15	13	16	14	18	15	19	16	20	17	22	18	23	19	24	20	26	21	27	22	28	23	30	24	31	25	32	26	34	27	35	28	36	29	38	30	39	31	40
// 13	15	14	16	15	18	16	19	17	20	18	22	19	23	20	24	21	26	22	27	23	28	24	30	25	31	26	32	27	34	28	35	29	36	30	38	31	39	32	40
// 14	15	15	16	16	18	17	19	18	20	19	22	20	23	21	24	22	26	23	27	24	28	25	30	26	31	27	32	28	34	29	35	30	36	31	38	32	39	33	40
// 15	16	16	17	17	19	18	20	19	21	20	23	21	24	22	25	23	27	24	28	25	29	26	31	27	32	28	33	29	35	30	36	31	37	32	39	33	40	34	41
// 16	16	17	17	18	19	19	20	20	21	21	23	22	24	23	25	24	27	25	28	26	29	27	31	28	32	29	33	30	35	31	36	32	37	33	39	34	40	35	41
// 17	17	18	18	19	20	20	21	21	22	22	24	23	25	24	26	25	28	26	29	27	30	28	32	29	33	30	34	31	36	32	37	33	38	34	40	35	41	36	42
// 18	17	19	18	20	20	21	21	22	22	23	24	24	25	25	26	26	28	27	29	28	30	29	32	30	33	31	34	32	36	33	37	34	38	35	40	36	41	37	42
// 19	18	20	19	21	21	22	22	23	23	24	25	25	26	26	27	27	29	28	30	29	31	30	33	31	34	32	35	33	37	34	38	35	39	36	41	37	42	38	43
// 20	18	21	19	22	21	23	22	24	23	25	25	26	26	27	27	28	29	29	30	30	31	31	33	32	34	33	35	34	37	35	38	36	39	37	41	38	42	39	43
// 21	19	22	20	23	22	24	23	25	24	26	26	27	27	28	28	29	30	30	31	31	32	32	34	33	35	34	36	35	38	36	39	37	40	38	42	39	43	40	44
// 22	19	23	20	24	22	25	23	26	24	27	26	28	27	29	28	30	30	31	31	32	32	33	34	34	35	35	36	36	38	37	39	38	40	39	42	40	43	41	44
// 23	20	24	21	25	23	26	24	27	25	28	27	29	28	30	29	31	31	32	32	33	33	34	35	35	36	36	37	37	39	38	40	39	41	40	43	41	44	42	45
// 24	21	25	22	26	24	27	25	28	26	29	28	30	29	31	30	32	32	33	33	34	34	35	36	36	37	37	38	38	40	39	41	40	42	41	44	42	45	43	46
// 25	22	26	23	27	25	28	26	29	27	30	29	31	30	32	31	33	33	34	34	35	35	36	37	37	38	38	39	39	41	40	42	41	43	42	45	43	46	44	47
// 26	23	27	24	28	26	29	27	30	28	31	30	32	31	33	32	34	34	35	35	36	36	37	38	38	39	39	40	40	42	41	43	42	44	43	46	44	47	45	48
// 27	24	28	25	29	27	30	28	31	29	32	31	33	32	34	33	35	35	36	36	37	37	38	39	39	40	40	41	41	43	42	44	43	45	44	47	45	48	46	49
// 28	25	29	26	30	28	31	29	32	30	33	32	34	33	35	34	36	36	37	37	38	38	39	40	40	41	41	42	42	44	43	45	44	46	45	48	46	49	47	50

import type { InlineCheck } from 'packages/obsidian/src/rolls/InlineCheck';
import { GameSystem } from 'packages/obsidian/src/rolls/InlineCheck';
import type { Pf1eMiscSkills, Pf1eSkills } from 'packages/obsidian/src/rolls/NaturalLanguageCheck';
import { PF1E_TO_PF2E_SKILL_MAP, Pf2eSkills } from 'packages/obsidian/src/rolls/NaturalLanguageCheck';

interface DCTableEntry {
	// the starting PF1e DC
	pf1eOffset: number;
	// `PF2E_DC_CURVE[pf1eDC - pf1eOffset] + pf2eOffset` gives the corresponding PF2e DC. This should always have length 31
	pf2eOffset: number;
}

const PF2E_DC_CURVE: number[] = [0, 1, 2, 3, 4, 5, 6, 6, 7, 7, 8, 8, 9, 9, 10, 10, 10, 11, 11, 12, 12, 13, 13, 14, 14, 15, 16, 17, 18, 19, 20];

const PF1E_TO_PF2E_DC_TABLE: Record<number, DCTableEntry> = {
	1: { pf1eOffset: -2, pf2eOffset: 5 },
	2: { pf1eOffset: -1, pf2eOffset: 6 },
	3: { pf1eOffset: 0, pf2eOffset: 8 },
	4: { pf1eOffset: 1, pf2eOffset: 9 },
	5: { pf1eOffset: 2, pf2eOffset: 10 },
	6: { pf1eOffset: 3, pf2eOffset: 12 },
	7: { pf1eOffset: 4, pf2eOffset: 13 },
	8: { pf1eOffset: 5, pf2eOffset: 14 },
	9: { pf1eOffset: 6, pf2eOffset: 16 },
	10: { pf1eOffset: 7, pf2eOffset: 17 },
	11: { pf1eOffset: 8, pf2eOffset: 18 },
	12: { pf1eOffset: 9, pf2eOffset: 20 },
	13: { pf1eOffset: 10, pf2eOffset: 21 },
	14: { pf1eOffset: 11, pf2eOffset: 22 },
	15: { pf1eOffset: 12, pf2eOffset: 24 },
	16: { pf1eOffset: 13, pf2eOffset: 25 },
	17: { pf1eOffset: 14, pf2eOffset: 26 },
	18: { pf1eOffset: 15, pf2eOffset: 28 },
	19: { pf1eOffset: 16, pf2eOffset: 29 },
	20: { pf1eOffset: 17, pf2eOffset: 30 },
};

export function pf2eLevelBasedDC(level: number): number {
	const entry = PF1E_TO_PF2E_DC_TABLE[level];
	if (!entry) throw new Error(`Invalid level ${level}`);
	return entry.pf2eOffset + 10;
}

export function convertPf1eToPf2eDC(level: number, pf1eDC: number): number | undefined {
	const entry = PF1E_TO_PF2E_DC_TABLE[level];
	if (!entry) return undefined;
	const index = pf1eDC - entry.pf1eOffset;
	if (index < 0 || index >= PF2E_DC_CURVE.length) return undefined;
	return PF2E_DC_CURVE[index] + entry.pf2eOffset;
}

export enum Pf2eProficiency {
	UNTRAINED = 'Untrained',
	TRAINED = 'Trained',
	EXPERT = 'Expert',
	MASTER = 'Master',
	LEGENDARY = 'Legendary',
}

export function pf2eCheckRequiredProficiency(pf2eDC: number): Pf2eProficiency {
	if (pf2eDC < 15) return Pf2eProficiency.UNTRAINED;
	if (pf2eDC < 20) return Pf2eProficiency.TRAINED;
	if (pf2eDC < 30) return Pf2eProficiency.EXPERT;
	if (pf2eDC < 40) return Pf2eProficiency.MASTER;
	return Pf2eProficiency.LEGENDARY;
}

export enum Pf2eCheckDifficulty {
	INCREDIBLY_EASY = 'Incredibly easy',
	VERY_EASY = 'Very easy',
	EASY = 'Easy',
	AVERAGE = 'Average',
	HARD = 'Hard',
	VERY_HARD = 'Very hard',
	INCREDIBLY_HARD = 'Incredibly hard',
}

/**
 * Assess the difficulty of a PF2e check given the character level and the DC.
 * Uses the following table:
 * Difficulty             Adjustment
 * Incredibly easy	      -10
 * Very easy	          -5
 * Easy	                  -2
 * Hard	                  +2
 * Very hard	          +5
 * Incredibly hard	      +10

 * @param level
 * @param pf2eDC
 * @returns
 */
export function pf2eCheckDifficulty(level: number, pf2eDC: number): Pf2eCheckDifficulty {
	const levelBasedDC = pf2eLevelBasedDC(level);
	const diff = pf2eDC - levelBasedDC;
	if (diff <= -10) return Pf2eCheckDifficulty.INCREDIBLY_EASY;
	if (diff <= -5) return Pf2eCheckDifficulty.VERY_EASY;
	if (diff <= -2) return Pf2eCheckDifficulty.EASY;
	if (diff < 2) return Pf2eCheckDifficulty.AVERAGE;
	if (diff < 5) return Pf2eCheckDifficulty.HARD;
	if (diff < 10) return Pf2eCheckDifficulty.VERY_HARD;
	return Pf2eCheckDifficulty.INCREDIBLY_HARD;
}

export function convertPf1eSkillToPf2eSkill(pf1eSkill: string): string[] {
	return PF1E_TO_PF2E_SKILL_MAP[pf1eSkill as Pf1eSkills | Pf1eMiscSkills] || [pf1eSkill];
}

export function convertPf1eCheckToPf2eCheck(pf1eCheck: InlineCheck, level: number, excludeLore: boolean): InlineCheck {
	if (pf1eCheck.system !== GameSystem.PF1E) {
		throw new Error('Can only convert pf1e checks to pf2e checks');
	}
	if (pf1eCheck.adjustment && pf1eCheck.adjustment.length !== pf1eCheck.type.length) {
		throw new Error('Pf1e check adjustment length must match type length');
	}

	const pf2eTypes = pf1eCheck.type.map((t, i) => [convertPf1eSkillToPf2eSkill(t), pf1eCheck.adjustment ? pf1eCheck.adjustment[i] : 0] as const);

	// dedupe types, keeping the lowest adjustment
	const typeMap = new Map<string, number>();
	for (const [types, adj] of pf2eTypes) {
		for (const type of types) {
			if (!typeMap.has(type) || (typeMap.get(type) ?? 0) > adj) {
				typeMap.set(type, adj);
			}
		}
	}

	if (excludeLore) {
		typeMap.delete(Pf2eSkills.Lore);
	}

	const flatTypes = Array.from(typeMap.keys());
	const adjustments = Array.from(typeMap.values());

	return {
		system: GameSystem.PF2E,
		type: flatTypes,
		dc: pf1eCheck.dc !== undefined ? convertPf1eToPf2eDC(level, pf1eCheck.dc) : undefined,
		adjustment: adjustments,
		other: [],
	};
}

export function getPf2eCheckClassification(check: InlineCheck, level: number | undefined): string {
	const difficulty = getDifficultyString(check, level);
	const requiredProf = getRequiredProficiencyString(check);
	return [difficulty, requiredProf].filter(Boolean).join('; ');
}

function getDifficultyString(check: InlineCheck, level: number | undefined): string {
	if (!check || level === undefined || check.dc === undefined) {
		return '';
	}

	const difficulty = pf2eCheckDifficulty(level, check.dc);
	const levelBasedDC = pf2eLevelBasedDC(level);
	const diff = check.dc - levelBasedDC;
	const diffSign = diff >= 0 ? '+' : '';
	const diffStr = `${diffSign}${diff}`;
	return `${difficulty} (${diffStr})`;
}

function getRequiredProficiencyString(check: InlineCheck): string {
	if (check?.dc === undefined) {
		return '';
	}

	return pf2eCheckRequiredProficiency(check.dc);
}
